# 功能描述

## 语法扩展

对 SillyTavern 的宏语法进行扩展，以支持更复杂的语法，例如条件判断、循环、读取更多信息等.

兼容 SillyTavern 原有的宏，扩展的语法基于 [Embedded JavaScript templating](https://ejs.co/) 实现，能够在提示词中使用 `JavaScript`。

能够在**世界/知识书**、**预设**中的**提示词**、**角色相关内容**、**消息**中执行.

仅需要将提示词中使用`<% ... %>`语句块即可。

例如

```javascript
<% print('hello world!') %>
```

> 完整语法说明：[EJS Syntax Reference](https://github.com/mde/ejs/blob/main/docs/syntax.md)
>
> 可以函数列表：[Reference](reference_cn.md)

此功能将会在**将提示词发生给LLM**和**将LLM输出渲染到 SillyTavern 中**时执行

---

## 处理模板

此扩展将会在**开始生成**时将 **SillyTavern** 构建的提示词进行处理，执行`<% ... %>`语句块中的所有`JavaScript`代码，然后将其替换为相应的执行结果（如果有输出）

执行顺序：

1. SillyTavern 准备生成时的提示词（合并**预设**、**世界/知识书**、**角色定义**、**消息**等内容）
2. **此扩展**对提示词中的所有`<% ... %>`语句块进行处理
3. 将处理后的提示词发生到**LLM**
4. 接收**LLM**输出的内容，将其渲染到 SillyTavern 的消息当中
5. 待SillyTavern接收完全部的LLM输出后，**此扩展**开始对接收的内容进行处理（即处理可见的`<% ... %>`语句块）



例如，准备的提示词为：

```javascript
当前好感度：<%- variables.好感度 %>/100
```

此扩展会读取`variables.好感度`的值，并将语句块替换为实际的值

```javascript
当前好感度：50/100
```

然后，该内容将会发送到LLM并开始生成

当LLM生成接受后，如果输出中包含以下内容：

```javascript
<% setvar('好感度', 60) -%>
新的好感度: <%- variables.好感度 %>/100
```

此扩展将会对输出结果进行处理，最终显示结果为：

```javascript
新的好感度: 60/100
```

---

## 提示词注入

在某些情况下，**世界/知识书**执行顺序无法被控制，为了确保提示词能够放置在指定的位置，此功能允许将特定提示词插入到**开头**以及**结束**位置。

只需要为**世界/知识书**条目中的**标题（备忘）**添加前缀即可将该条目的内容注入到相应顺序，**必须设置为未激活才会生效**。

此功能会受到**触发策略**、**顺序**、**包含组**、**确定优先级**、**触发概率**、**组权重**、**主要关键字**、**逻辑**以及**可选过滤器**影响。

> 黏性、冷却和延迟未实现。

- `[GENERATE:BEFORE]`：将此条目注入到**发送给LLM**的提示词的开头（仅限🔵）
- `[GENERATE:AFTER]`：将此条目的内容注入到**发送给LLM**的提示词的末尾（🔵和🟢）
- `[RENDER:BEFORE]`：将此条目注入到**接收的LLM的输出**的内容开头（仅限🔵）
- `[RENDER:AFTER]`：将此条目注入到**接收的LLM的输出**的内容结尾（🔵和🟢）

